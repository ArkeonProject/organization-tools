# .github/workflows/reusable/release-publish.yml
# Reusable workflow for publishing releases after merge to main

name: ðŸŽ‰ Publish Release

on:
  workflow_call:
    inputs:
      project-type:
        description: 'Project type (node, python)'
        required: true
        type: string
      
      create-github-release:
        description: 'Create GitHub Release'
        required: false
        type: boolean
        default: true
      
      auto-back-merge:
        description: 'Auto back-merge to develop'
        required: false
        type: boolean
        default: true

jobs:
  publish:
    name: Publish Release
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      
      - name: âš™ï¸ Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: ðŸ“Œ Get version (Node)
        if: inputs.project-type == 'node'
        id: version-node
        run: echo "version=$(jq -r .version package.json)" >> $GITHUB_OUTPUT
      
      - name: ðŸ“Œ Get version (Python)
        if: inputs.project-type == 'python'
        id: version-python
        run: |
          VERSION=$(grep -E '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: ðŸ·ï¸ Create tag
        id: tag
        run: |
          VERSION="${{ steps.version-node.outputs.version || steps.version-python.outputs.version }}"
          TAG="v$VERSION"
          
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag exists"
          else
            git tag -a "$TAG" -m "Release $TAG"
            git push origin "$TAG"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
      
      - name: ðŸŽ‰ Create GitHub Release
        if: inputs.create-github-release
        uses: actions/github-script@v7
        with:
          script: |
            const tag = '${{ steps.tag.outputs.tag }}';
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: `Release ${tag}`,
              body: 'Release notes',
              draft: false,
              prerelease: false
            });
      
      - name: ðŸ”„ Back-merge to develop
        if: inputs.auto-back-merge
        run: |
          git fetch origin
          git checkout develop
          git merge origin/main --no-ff -m "chore: back-merge ${{ steps.tag.outputs.tag }}"
          git push origin develop
        continue-on-error: true
